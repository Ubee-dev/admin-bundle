name: CI

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump
        id: bump
        run: |
          MSG=$(git log -1 --pretty=%B)
          if echo "$MSG" | grep -qi '\[major\]'; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -qi '\[minor\]'; then
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            echo "type=patch" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        run: |
          LATEST=$(git tag -l 'v*' --sort=-v:refname | head -1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi

          VERSION=${LATEST#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          BUMP="${{ steps.bump.outputs.type }}"
          if [ "$BUMP" = "major" ]; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$BUMP" = "minor" ]; then
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            PATCH=$((PATCH + 1))
          fi

          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "Creating tag $NEW_TAG"
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"
